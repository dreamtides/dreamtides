#!/bin/sh
#
# Pre-commit hook to regenerate code from Tabula source files
#

# Get the repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Check if any tabula TOML or FTL files are being committed
TOML_CHANGES=$(git diff --cached --name-only -- '*.toml' '*.ftl' | grep -E '^rules_engine/tabula/' || true)

if [ -n "$TOML_CHANGES" ]; then
    echo "Tabula files changed, regenerating..."

    # Run tabula generate
    if ! cargo run --manifest-path "$REPO_ROOT/rules_engine/Cargo.toml" -p tabula_cli -- generate 2>&1; then
        echo "Error: tabula generate failed" >&2
        exit 1
    fi

    # Stage generated files if changed
    git diff --quiet -- "$REPO_ROOT/rules_engine/tabula/parsed_abilities.json" || \
        git add "$REPO_ROOT/rules_engine/tabula/parsed_abilities.json"
    git diff --quiet -- "$REPO_ROOT/rules_engine/src/tabula_generated/src/" || \
        git add "$REPO_ROOT/rules_engine/src/tabula_generated/src/"
fi

exit 0
